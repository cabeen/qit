<?xml version = '1.0' encoding = 'ISO-8859-1' ?>
<project name="qit" default="dist">

  <target name="buildinfo">

    <exec executable="git" outputproperty="commit">
		  <arg value="rev-parse" />
		  <arg value="HEAD" />
		</exec>
    <exec executable="date" outputproperty="timestamp">
		  <arg value="+%F-%T-%Z" />
		</exec>
    <exec executable="whoami" outputproperty="whoami"/>
    <exec executable="uname" outputproperty="buildsystem">
      <arg value="-a"/>
    </exec>

    <propertyfile 
      file="dist/doc/build.properties"
      comment=" This file is automatically generated to document the build">
      <entry key="commit" value="${commit}"/>
      <entry key="timestamp" value="${timestamp}"/>
      <entry key="builder" value="${whoami}"/>
      <entry key="system" value="${buildsystem}"/>
    </propertyfile>
  </target>

  <target name="initlibskip" >
    <uptodate 
      targetfile="build/lib.jar" 
      property="libskip" 
      value="true" > 
      <srcfiles dir="lib/jars" includes="**/*.jar" />
    </uptodate>
  </target>
  
  <!-- jdk 9 is extremely slow to compile with many jars on the classpath
       so as a workaround, let's unzip the jars and bundle them all as a single 
       jar.  Running the jdk 9 jvm seems fine with many jars, so we'll still
       distribute each dependency as an individual jar -->

  <target name="lib" depends="initlibskip" unless="libskip" >
    <mkdir dir="build" />
    <mkdir dir="build/lib" />
    <unzip dest="build/lib">
      <fileset dir="lib/jars">
        <include name="**/*.jar" />
      </fileset>
    </unzip>
    <jar destfile="build/lib.jar" basedir="build/lib" />
  </target>

  <target name="compile" depends="lib" >
    <mkdir dir="build/qit" />
    <javac 
      srcdir="src" 
      destdir="build/qit" 
      classpath="build/lib.jar"  
      excludes="test**"
      target="11" 
      source="11" 
      debug="on" 
      debuglevel="lines,vars,source"
      includeantruntime="false"/>
  </target>

  <target name="jar" depends="compile">
    <jar jarfile="build/qit.jar" >
      <fileset dir="build/qit" />
      <fileset dir="build/lib" />
      <manifest>
        <attribute name="Main-Class" value="qitview.main.QitViewMain" />
        <attribute name="Author" value="Ryan Cabeen, cabeen@gmail.com" />
      </manifest>
    </jar>
  </target>

  <!-- we built a fat jar for qit (includes all dependencies), but we should
       also distribute each dependency as a separate jar to play nicely with
       their license agreements (alas, a bit wasteful) -->

  <target name="build" depends="jar">
    <mkdir dir="dist" />
    <copy todir="dist/bin">
      <fileset dir="bin" />
    </copy>
    <copy todir="dist/lib">
      <fileset dir="lib" />
    </copy>
    <copy todir="dist/share">
      <fileset dir="share" />
    </copy>
    <copy todir="dist/lib/modules/qit">
        <fileset dir="src/qit/scripts" />
    </copy>
    <copy todir="dist/lib/qitmake">
      <fileset dir="src/qitmake" />
    </copy>
    <copy todir="dist/doc">
      <fileset dir="doc" />
    </copy>
    <copy file="build/qit.jar" tofile="dist/lib/jars/qit.jar"/>
    <chmod dir="dist/bin" perm="ugo+rx" includes="**/**"/>
    <chmod dir="dist/bin" perm="a+x" type="both" includes="**/**"/>
  </target>

  <target name="dist" depends="build,buildinfo">
  </target>

  <target name="install" depends="dist">
    <copy todir="../qit-install">
      <fileset dir="dist" />
    </copy>
    <chmod dir="../qit-install/bin" perm="a+x" type="both" includes="**/**"/>
  </target>

  <target name="clean">
    <delete dir="build" />
    <delete dir="dist" />
  </target>
</project>
